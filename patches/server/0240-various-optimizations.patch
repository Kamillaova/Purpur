From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kamillaova <54859825+Kamillaova@users.noreply.github.com>
Date: Tue, 31 Jan 2023 17:13:05 +0300
Subject: [PATCH] various optimizations


diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index 5730e628058e6071b56b445f798c50fdb5411fde..c00e2685ed9618403c528931c398d59f52103b3d 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -8,6 +8,7 @@ import java.util.Map;
 import java.util.stream.Collectors;
 
 import com.destroystokyo.paper.antixray.ChunkPacketBlockControllerAntiXray.EngineMode;
+import dev.kamillaova.paper.SimpleEnumMap;
 import net.minecraft.world.EnumDifficulty;
 import net.minecraft.world.entity.EntityTypes;
 import net.minecraft.world.entity.monster.EntityVindicator;
@@ -562,11 +563,7 @@ public class PaperWorldConfig {
 
         altItemDespawnRateEnabled = getBoolean(path + ".enabled", false);
 
-        Map<Material, Integer> altItemDespawnRateMapDefault = new EnumMap<>(Material.class);
-        altItemDespawnRateMapDefault.put(Material.COBBLESTONE, 300);
-        for (Material key : altItemDespawnRateMapDefault.keySet()) {
-            config.addDefault("world-settings.default." + path + ".items." + key, altItemDespawnRateMapDefault.get(key));
-        }
+        config.addDefault("world-settings.default." + path + ".items." + Material.COBBLESTONE, 300);
 
         Map<String, Integer> rawMap = new HashMap<>();
         try {
@@ -584,7 +581,7 @@ public class PaperWorldConfig {
             altItemDespawnRateEnabled = false;
         }
 
-        altItemDespawnRateMap = new EnumMap<>(Material.class);
+        altItemDespawnRateMap = new SimpleEnumMap<>(Material.VALUES);
         if (!altItemDespawnRateEnabled) {
             return;
         }
diff --git a/src/main/java/com/destroystokyo/paper/io/QueueExecutorThread.java b/src/main/java/com/destroystokyo/paper/io/QueueExecutorThread.java
index ee906b594b306906c170180a29a8b61997d05168..a6da40d0fadf0e81874db63043cb02bc7d3ccc7d 100644
--- a/src/main/java/com/destroystokyo/paper/io/QueueExecutorThread.java
+++ b/src/main/java/com/destroystokyo/paper/io/QueueExecutorThread.java
@@ -189,7 +189,7 @@ public class QueueExecutorThread<T extends PrioritizedTaskQueue.PrioritizedTask
             final long currentCycle = this.flushCycles; // may be opaque read
 
             if (currentCycle == lastCycle) {
-                Thread.yield();
+                Thread.onSpinWait();
                 continue;
             }
 
diff --git a/src/main/java/com/destroystokyo/paper/util/concurrent/WeakSeqLock.java b/src/main/java/com/destroystokyo/paper/util/concurrent/WeakSeqLock.java
index 4029dc68cf35d63aa70c4a76c35bf65a7fc6358f..30e0cba32875874eaab190ed27b7e15ef5110ce5 100644
--- a/src/main/java/com/destroystokyo/paper/util/concurrent/WeakSeqLock.java
+++ b/src/main/java/com/destroystokyo/paper/util/concurrent/WeakSeqLock.java
@@ -1,27 +1,47 @@
 package com.destroystokyo.paper.util.concurrent;
 
-import java.util.concurrent.atomic.AtomicLong;
+import java.lang.invoke.MethodHandles;
+import java.lang.invoke.VarHandle;
 
 /**
  * copied from https://github.com/Spottedleaf/ConcurrentUtil/blob/master/src/main/java/ca/spottedleaf/concurrentutil/lock/WeakSeqLock.java
+ *
  * @author Spottedleaf
  */
 public final class WeakSeqLock {
-    // TODO when the switch to J11 is made, nuke this class from orbit
 
-    protected final AtomicLong lock = new AtomicLong();
+    private long lock;
 
-    public WeakSeqLock() {
-        //VarHandle.storeStoreFence(); // warn: usages must be checked to ensure this behaviour isn't needed
+    private static final VarHandle LOCK_HANDLE;
+
+    static {
+        try {
+            LOCK_HANDLE = MethodHandles.lookup().findVarHandle(WeakSeqLock.class, "lock", long.class);
+        } catch (Throwable t) {
+            throw new ExceptionInInitializerError(t);
+        }
     }
 
-    public void acquireWrite() {
-        // must be release-type write
-        this.lock.lazySet(this.lock.get() + 1);
+    private long getLockPlain() {
+        return (long) LOCK_HANDLE.get(this);
     }
 
-    public boolean canRead(final long read) {
-        return (read & 1) == 0;
+    private long getLockOpaque() {
+        return (long) LOCK_HANDLE.getOpaque(this);
+    }
+
+    private void setLockOpaque(final long value) {
+        LOCK_HANDLE.setOpaque(this, value);
+    }
+
+    public WeakSeqLock() {
+        VarHandle.storeStoreFence();
+    }
+
+    public void acquireWrite() {
+        final long lock = this.getLockPlain();
+        this.setLockOpaque(lock + 1);
+        VarHandle.storeStoreFence();
     }
 
     public boolean tryAcquireWrite() {
@@ -30,23 +50,25 @@ public final class WeakSeqLock {
     }
 
     public void releaseWrite() {
-        // must be acquire-type write
-        final long lock = this.lock.get(); // volatile here acts as store-store
-        this.lock.lazySet(lock + 1);
+        final long lock = this.getLockPlain();
+        VarHandle.storeStoreFence();
+        this.setLockOpaque(lock + 1);
     }
 
     public void abortWrite() {
-        // must be acquire-type write
-        final long lock = this.lock.get(); // volatile here acts as store-store
-        this.lock.lazySet(lock ^ 1);
+        final long lock = this.getLockPlain();
+        VarHandle.storeStoreFence();
+        this.setLockOpaque(lock ^ 1);
     }
 
     public long acquireRead() {
-        int failures = 0;
+        long failures = 0;
         long curr;
 
-        for (curr = this.lock.get(); !this.canRead(curr); curr = this.lock.get()) {
-            // without j11, our only backoff is the yield() call...
+        for (curr = this.getLockOpaque(); !this.canRead(curr); curr = this.getLockOpaque()) {
+            for (int i = 0; i < failures; ++i) {
+                Thread.onSpinWait();
+            }
 
             if (++failures > 5_000) { /* TODO determine a threshold */
                 Thread.yield();
@@ -54,15 +76,22 @@ public final class WeakSeqLock {
             /* Better waiting is beyond the scope of this lock; if it is needed the lock is being misused */
         }
 
-        //VarHandle.loadLoadFence(); // volatile acts as the load-load barrier
+        VarHandle.loadLoadFence();
         return curr;
     }
 
     public boolean tryReleaseRead(final long read) {
-        return this.lock.get() == read; // volatile acts as the load-load barrier
+        VarHandle.loadLoadFence();
+        return this.getLockOpaque() == read;
     }
 
     public long getSequentialCounter() {
-        return this.lock.get();
+        final long lock = this.getLockOpaque();
+        VarHandle.loadLoadFence();
+        return lock;
+    }
+
+    public boolean canRead(final long read) {
+        return (read & 1) == 0;
     }
 }
diff --git a/src/main/java/com/destroystokyo/paper/util/set/OptimizedSmallEnumSet.java b/src/main/java/com/destroystokyo/paper/util/set/OptimizedSmallEnumSet.java
index b3329c6fcd6758a781a51f5ba8f5052ac1c77b49..84d582e5244bf7a5faa49d0b286c9b8c138f1348 100644
--- a/src/main/java/com/destroystokyo/paper/util/set/OptimizedSmallEnumSet.java
+++ b/src/main/java/com/destroystokyo/paper/util/set/OptimizedSmallEnumSet.java
@@ -6,8 +6,6 @@ import java.util.Collection;
  * @author Spottedleaf <Spottedleaf@users.noreply.github.com>
  */
 public final class OptimizedSmallEnumSet<E extends Enum<E>> {
-
-    private final Class<E> enumClass;
     private long backingSet;
 
     public OptimizedSmallEnumSet(final Class<E> clazz) {
@@ -17,7 +15,6 @@ public final class OptimizedSmallEnumSet<E extends Enum<E>> {
         if (!clazz.isEnum()) {
             throw new IllegalArgumentException("Class must be enum, not " + clazz.getCanonicalName());
         }
-        this.enumClass = clazz;
     }
 
     public boolean addUnchecked(final E element) {
diff --git a/src/main/java/net/minecraft/network/NetworkManager.java b/src/main/java/net/minecraft/network/NetworkManager.java
index 1dce5d3b1e994a060067de4901912dd5a9be7e15..08a162210e50ddeec45ae04e716899097350202c 100644
--- a/src/main/java/net/minecraft/network/NetworkManager.java
+++ b/src/main/java/net/minecraft/network/NetworkManager.java
@@ -178,6 +178,7 @@ public class NetworkManager extends SimpleChannelInboundHandler<Packet<?>> {
     }
 
     public void exceptionCaught(ChannelHandlerContext channelhandlercontext, Throwable throwable) {
+        throwable.printStackTrace();
         // Paper start
         if (throwable instanceof EncoderException && throwable.getCause() instanceof PacketEncoder.PacketTooLargeException) {
             if (((PacketEncoder.PacketTooLargeException) throwable.getCause()).getPacket().packetTooLarge(this)) {
diff --git a/src/main/java/net/minecraft/server/network/LoginListener.java b/src/main/java/net/minecraft/server/network/LoginListener.java
index f378d654a7fdd61ca31ca50ba45eff6acd93c3f1..bba3ed645efbb9c7f57c37c4f8b72a2f4fc400ff 100644
--- a/src/main/java/net/minecraft/server/network/LoginListener.java
+++ b/src/main/java/net/minecraft/server/network/LoginListener.java
@@ -2,8 +2,12 @@ package net.minecraft.server.network;
 
 import com.destroystokyo.paper.profile.CraftPlayerProfile;
 import com.destroystokyo.paper.profile.PlayerProfile;
+import com.google.common.util.concurrent.ThreadFactoryBuilder;
 import com.mojang.authlib.GameProfile;
 import com.mojang.authlib.exceptions.AuthenticationUnavailableException;
+
+import java.lang.invoke.MethodHandles;
+import java.lang.invoke.MethodType;
 import java.math.BigInteger;
 import java.net.InetAddress;
 import java.net.InetSocketAddress;
@@ -12,6 +16,11 @@ import java.security.PrivateKey;
 import java.util.Arrays;
 import java.util.Random;
 import java.util.UUID;
+import java.util.concurrent.ExecutorService;
+import java.util.concurrent.Executors;
+import java.util.concurrent.LinkedBlockingQueue;
+import java.util.concurrent.ThreadPoolExecutor;
+import java.util.concurrent.TimeUnit;
 import java.util.concurrent.atomic.AtomicInteger;
 import javax.annotation.Nullable;
 import javax.crypto.Cipher;
@@ -49,6 +58,8 @@ import org.bukkit.event.player.PlayerPreLoginEvent;
 // CraftBukkit end
 import io.netty.buffer.Unpooled; // Paper
 
+import static java.lang.invoke.MethodType.methodType;
+
 public class LoginListener implements PacketLoginInListener {
 
     private static final AtomicInteger b = new AtomicInteger(0);
@@ -127,10 +138,27 @@ public class LoginListener implements PacketLoginInListener {
     }
 
     // Paper start - Cache authenticator threads
-    private static final AtomicInteger threadId = new AtomicInteger(0);
-    private static final java.util.concurrent.ExecutorService authenticatorPool = java.util.concurrent.Executors.newCachedThreadPool(
-            r -> new Thread(r, "User Authenticator #" + threadId.incrementAndGet())
-    );
+    private static final ExecutorService authenticatorPool;
+    static {
+        ExecutorService pool;
+        try {
+            pool = (ExecutorService) MethodHandles.publicLookup().findStatic(
+              Executors.class,
+              "newVirtualThreadPerTaskExecutor", // TODO: fuck toothpick
+              methodType(ExecutorService.class)
+            ).invokeExact();
+        } catch (Throwable t) {
+            var tpe = new ThreadPoolExecutor(
+              1, 64,
+              1, TimeUnit.MINUTES,
+              new LinkedBlockingQueue<>()
+            );
+            tpe.prestartAllCoreThreads();
+            tpe.allowCoreThreadTimeOut(false);
+            pool = tpe;
+        }
+        authenticatorPool = pool;
+    }
     // Paper end
     // Spigot start
     public void initUUID()
diff --git a/src/main/java/net/minecraft/stats/ServerStatisticManager.java b/src/main/java/net/minecraft/stats/ServerStatisticManager.java
index 1efab34e03199879f5e0dcee0ff79ce2c23c73bc..b8567fff1f2070c4342d8abcce5f32c256110947 100644
--- a/src/main/java/net/minecraft/stats/ServerStatisticManager.java
+++ b/src/main/java/net/minecraft/stats/ServerStatisticManager.java
@@ -32,6 +32,7 @@ import net.minecraft.server.MinecraftServer;
 import net.minecraft.server.level.EntityPlayer;
 import net.minecraft.util.datafix.DataFixTypes;
 import net.minecraft.world.entity.player.EntityHuman;
+import net.pl3x.purpur.PurpurConfig;
 import org.apache.commons.io.FileUtils;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
@@ -41,17 +42,18 @@ public class ServerStatisticManager extends StatisticManager {
     private static final Logger LOGGER = LogManager.getLogger();
     private final MinecraftServer c;
     private final File d;
-    private final Set<Statistic<?>> e = Sets.newHashSet();
+    private Set<Statistic<?>> e = null;
     private int f = -300;
 
     public ServerStatisticManager(MinecraftServer minecraftserver, File file) {
         this.c = minecraftserver;
         this.d = file;
+        if (PurpurConfig.disableStatistics) return;
+        e = Sets.newHashSet();
         // Spigot start
-        for ( Map.Entry<MinecraftKey, Integer> entry : org.spigotmc.SpigotConfig.forcedStats.entrySet() )
-        {
-            Statistic<MinecraftKey> wrapper = StatisticList.CUSTOM.b( entry.getKey() );
-            this.a.put( wrapper, entry.getValue().intValue() );
+        for (Map.Entry<MinecraftKey, Integer> entry : org.spigotmc.SpigotConfig.forcedStats.entrySet()) {
+            Statistic<MinecraftKey> wrapper = StatisticList.CUSTOM.b(entry.getKey());
+            this.a.put(wrapper, entry.getValue().intValue());
         }
         // Spigot end
         if (file.isFile()) {
@@ -63,10 +65,10 @@ public class ServerStatisticManager extends StatisticManager {
                 ServerStatisticManager.LOGGER.error("Couldn't parse statistics file {}", file, jsonparseexception);
             }
         }
-
     }
 
     public void save() {
+        if (PurpurConfig.disableStatistics) return;
         if ( org.spigotmc.SpigotConfig.disableStatSaving ) return; // Spigot
         try {
             FileUtils.writeStringToFile(this.d, this.b());
@@ -78,6 +80,7 @@ public class ServerStatisticManager extends StatisticManager {
 
     @Override
     public void setStatistic(EntityHuman entityhuman, Statistic<?> statistic, int i) {
+        if (PurpurConfig.disableStatistics) return;
         if ( org.spigotmc.SpigotConfig.disableStatSaving ) return; // Spigot
         super.setStatistic(entityhuman, statistic, i);
         this.e.add(statistic);
@@ -91,6 +94,7 @@ public class ServerStatisticManager extends StatisticManager {
     }
 
     public void a(DataFixer datafixer, String s) {
+        if (PurpurConfig.disableStatistics) return;
         try {
             JsonReader jsonreader = new JsonReader(new StringReader(s));
             Throwable throwable = null;
@@ -168,6 +172,7 @@ public class ServerStatisticManager extends StatisticManager {
     }
 
     private <T> Optional<Statistic<T>> a(StatisticWrapper<T> statisticwrapper, String s) {
+        if (PurpurConfig.disableStatistics) return Optional.empty();
         // CraftBukkit - decompile error start
         Optional<MinecraftKey> optional = Optional.ofNullable(MinecraftKey.a(s));
         IRegistry<T> iregistry = statisticwrapper.getRegistry();
@@ -178,6 +183,7 @@ public class ServerStatisticManager extends StatisticManager {
 
     private static NBTTagCompound a(JsonObject jsonobject) {
         NBTTagCompound nbttagcompound = new NBTTagCompound();
+        if (PurpurConfig.disableStatistics) return nbttagcompound;
         Iterator iterator = jsonobject.entrySet().iterator();
 
         while (iterator.hasNext()) {
@@ -198,7 +204,7 @@ public class ServerStatisticManager extends StatisticManager {
         return nbttagcompound;
     }
 
-    protected String b() {
+    private String b() {
         Map<StatisticWrapper<?>, JsonObject> map = Maps.newHashMap();
         ObjectIterator objectiterator = this.a.object2IntEntrySet().iterator();
 
@@ -232,10 +238,12 @@ public class ServerStatisticManager extends StatisticManager {
     }
 
     public void c() {
+        if (PurpurConfig.disableStatistics) return;
         this.e.addAll(this.a.keySet());
     }
 
     public void a(EntityPlayer entityplayer) {
+        if (PurpurConfig.disableStatistics) return;
         int i = this.c.ai();
         Object2IntMap<Statistic<?>> object2intmap = new Object2IntOpenHashMap();
 
diff --git a/src/main/java/net/minecraft/stats/StatisticManager.java b/src/main/java/net/minecraft/stats/StatisticManager.java
index c95fb97262528da2e04d0e9ee8601abad242dabb..59c4ef7eb3a8bacf90776cfa69b647ee64a76b00 100644
--- a/src/main/java/net/minecraft/stats/StatisticManager.java
+++ b/src/main/java/net/minecraft/stats/StatisticManager.java
@@ -4,32 +4,46 @@ import it.unimi.dsi.fastutil.objects.Object2IntMap;
 import it.unimi.dsi.fastutil.objects.Object2IntMaps;
 import it.unimi.dsi.fastutil.objects.Object2IntOpenHashMap;
 import net.minecraft.world.entity.player.EntityHuman;
+import net.pl3x.purpur.PurpurConfig;
 
 public class StatisticManager {
 
-    protected final Object2IntMap<Statistic<?>> a = Object2IntMaps.synchronize(new Object2IntOpenHashMap());
+    protected final Object2IntMap<Statistic<?>> a;
 
     public StatisticManager() {
-        this.a.defaultReturnValue(0);
+        if (PurpurConfig.disableStatistics) {
+            a = null;
+        } else {
+            this.a = Object2IntMaps.synchronize(new Object2IntOpenHashMap<>());
+            this.a.defaultReturnValue(0);
+        }
     }
 
     public void b(EntityHuman entityhuman, Statistic<?> statistic, int i) {
-        int j = (int) Math.min((long) this.getStatisticValue(statistic) + (long) i, 2147483647L);
-
-        // CraftBukkit start - fire Statistic events
-        org.bukkit.event.Cancellable cancellable = org.bukkit.craftbukkit.event.CraftEventFactory.handleStatisticsIncrease(entityhuman, statistic, this.getStatisticValue(statistic), j);
-        if (cancellable != null && cancellable.isCancelled()) {
-            return;
+        if (!PurpurConfig.disableStatistics) {
+            int j = (int) Math.min((long) this.getStatisticValue(statistic) + (long) i, 2147483647L);
+
+            // CraftBukkit start - fire Statistic events
+            org.bukkit.event.Cancellable cancellable = org.bukkit.craftbukkit.event.CraftEventFactory.handleStatisticsIncrease(entityhuman, statistic, this.getStatisticValue(statistic), j);
+            if (cancellable != null && cancellable.isCancelled()) {
+                return;
+            }
+            // CraftBukkit end
+            this.setStatistic(entityhuman, statistic, j);
         }
-        // CraftBukkit end
-        this.setStatistic(entityhuman, statistic, j);
     }
 
     public void setStatistic(EntityHuman entityhuman, Statistic<?> statistic, int i) {
-        this.a.put(statistic, i);
+        if (!PurpurConfig.disableStatistics) {
+            this.a.put(statistic, i);
+        }
     }
 
     public int getStatisticValue(Statistic<?> statistic) {
-        return this.a.getInt(statistic);
+        if (PurpurConfig.disableStatistics) {
+            return 0;
+        } else {
+            return this.a.getInt(statistic);
+        }
     }
 }
diff --git a/src/main/java/net/minecraft/util/thread/IAsyncTaskHandler.java b/src/main/java/net/minecraft/util/thread/IAsyncTaskHandler.java
index 158ea6d77698d62ba795aff6c061a80652e42e03..dd4fffa0b80aa89d56155ff2caa6b0a2b94f411d 100644
--- a/src/main/java/net/minecraft/util/thread/IAsyncTaskHandler.java
+++ b/src/main/java/net/minecraft/util/thread/IAsyncTaskHandler.java
@@ -117,7 +117,7 @@ public abstract class IAsyncTaskHandler<R extends Runnable> implements Mailbox<R
         try {
             while (!booleansupplier.getAsBoolean()) {
                 if (!this.executeNext()) {
-                    this.bm();
+                    LockSupport.parkNanos("waiting for tasks", 100000L);
                 }
             }
         } finally {
@@ -126,11 +126,6 @@ public abstract class IAsyncTaskHandler<R extends Runnable> implements Mailbox<R
 
     }
 
-    protected void bm() {
-        Thread.yield();
-        LockSupport.parkNanos("waiting for tasks", 100000L);
-    }
-
     protected void executeTask(R r0) {
         try {
             r0.run();
diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index 896b20c6c02b1b6892bbf61a7bcbd163b5c55f36..52e8d5bcf658bfa309003ce30eef8b64b3641d9c 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -110,6 +110,7 @@ import net.minecraft.world.phys.shapes.VoxelShapeCollision;
 import net.minecraft.world.phys.shapes.VoxelShapes;
 import net.minecraft.world.scores.ScoreboardTeam;
 import net.minecraft.world.scores.ScoreboardTeamBase;
+import net.pl3x.purpur.PurpurConfig;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 
@@ -1743,6 +1744,8 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, ne
     public void pickup(EntityHuman entityhuman) {}
 
     public void collide(Entity entity) {
+        if (PurpurConfig.disableEntityCollisions) return;
+
         if (!this.isSameVehicle(entity)) {
             if (!entity.noclip && !this.noclip) {
                 if (this.world.paperConfig.onlyPlayersCollide && !(entity instanceof EntityPlayer || this instanceof EntityPlayer)) return; // Paper
@@ -2712,15 +2715,18 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, ne
 
     @Nullable
     public ScoreboardTeamBase getScoreboardTeam() {
+        if (PurpurConfig.disableTeams) return null;
         if (!this.world.paperConfig.nonPlayerEntitiesOnScoreboards && !(this instanceof EntityHuman)) { return null; } // Paper
         return this.world.getScoreboard().getPlayerTeam(this.getName());
     }
 
     public boolean r(Entity entity) {
+        if (PurpurConfig.disableTeamAlly) return false;
         return this.a(entity.getScoreboardTeam());
     }
 
     public boolean a(ScoreboardTeamBase scoreboardteambase) {
+        if (PurpurConfig.disableTeamAlly) return false;
         return this.getScoreboardTeam() != null ? this.getScoreboardTeam().isAlly(scoreboardteambase) : false;
     }
 
diff --git a/src/main/java/net/minecraft/world/entity/EntityLiving.java b/src/main/java/net/minecraft/world/entity/EntityLiving.java
index 8fc7c8ec2409b3c161f01f58c02562026c20cf0c..9511b322770f4d86089f50482f5244c63bfc9d23 100644
--- a/src/main/java/net/minecraft/world/entity/EntityLiving.java
+++ b/src/main/java/net/minecraft/world/entity/EntityLiving.java
@@ -113,6 +113,7 @@ import net.minecraft.world.phys.MovingObjectPosition;
 import net.minecraft.world.phys.MovingObjectPositionEntity;
 import net.minecraft.world.phys.Vec3D;
 import net.minecraft.world.scores.ScoreboardTeam;
+import net.pl3x.purpur.PurpurConfig;
 import org.apache.logging.log4j.Logger;
 
 // CraftBukkit start
@@ -3073,6 +3074,8 @@ public abstract class EntityLiving extends Entity {
     protected void doTick() {}
 
     protected void collideNearby() {
+        if (PurpurConfig.disableEntityCollisions) return;
+
         // Paper - start don't run getEntities if we're not going to use its result
         int i = this.world.getGameRules().getInt(GameRules.MAX_ENTITY_CRAMMING);
         if (i <= 0 && world.paperConfig.maxCollisionsPerEntity <= 0) {
diff --git a/src/main/java/net/minecraft/world/entity/EntityTameableAnimal.java b/src/main/java/net/minecraft/world/entity/EntityTameableAnimal.java
index cdb56555889d17913d7b0c03d5ba23408a500f26..f8ce1fc52c87437e9b96b7f50957f32de2c1eff4 100644
--- a/src/main/java/net/minecraft/world/entity/EntityTameableAnimal.java
+++ b/src/main/java/net/minecraft/world/entity/EntityTameableAnimal.java
@@ -17,6 +17,7 @@ import net.minecraft.world.entity.player.EntityHuman;
 import net.minecraft.world.level.GameRules;
 import net.minecraft.world.level.World;
 import net.minecraft.world.scores.ScoreboardTeamBase;
+import net.pl3x.purpur.PurpurConfig;
 
 public abstract class EntityTameableAnimal extends EntityAnimal {
 
@@ -155,6 +156,7 @@ public abstract class EntityTameableAnimal extends EntityAnimal {
 
     @Override
     public ScoreboardTeamBase getScoreboardTeam() {
+        if (PurpurConfig.disableTeams) return null;
         if (this.isTamed()) {
             EntityLiving entityliving = this.getOwner();
 
diff --git a/src/main/java/net/minecraft/world/entity/IEntitySelector.java b/src/main/java/net/minecraft/world/entity/IEntitySelector.java
index f9908fb7cc27a8947030c2100dccf1dc1a4e24f7..80724a5d39233be9e0ae9bed5c887f537505aa72 100644
--- a/src/main/java/net/minecraft/world/entity/IEntitySelector.java
+++ b/src/main/java/net/minecraft/world/entity/IEntitySelector.java
@@ -11,6 +11,7 @@ import net.minecraft.world.IInventory;
 import net.minecraft.world.entity.player.EntityHuman;
 import net.minecraft.world.item.ItemStack;
 import net.minecraft.world.scores.ScoreboardTeamBase;
+import net.pl3x.purpur.PurpurConfig;
 
 public final class IEntitySelector {
 
@@ -58,6 +59,8 @@ public final class IEntitySelector {
     }
 
     public static Predicate<Entity> pushable(Entity entity, boolean ignoreClimbing) {
+        if (PurpurConfig.disableTeamCollisionRule) return __ -> true;
+
         // Paper end
         ScoreboardTeamBase scoreboardteambase = entity.getScoreboardTeam();
         ScoreboardTeamBase.EnumTeamPush scoreboardteambase_enumteampush = scoreboardteambase == null ? ScoreboardTeamBase.EnumTeamPush.ALWAYS : scoreboardteambase.getCollisionRule();
diff --git a/src/main/java/net/minecraft/world/entity/ai/goal/PathfinderGoal.java b/src/main/java/net/minecraft/world/entity/ai/goal/PathfinderGoal.java
index 1212c8e2af1f7e658d8bec7e5474a35190b1949e..0f511d0613d344f49dc92a663b618d4f92ef1c4d 100644
--- a/src/main/java/net/minecraft/world/entity/ai/goal/PathfinderGoal.java
+++ b/src/main/java/net/minecraft/world/entity/ai/goal/PathfinderGoal.java
@@ -5,7 +5,6 @@ import java.util.EnumSet;
 
 public abstract class PathfinderGoal {
 
-    private final EnumSet<PathfinderGoal.Type> a = EnumSet.noneOf(PathfinderGoal.Type.class); // Paper unused, but dummy to prevent plugins from crashing as hard. Theyll need to support paper in a special case if this is super important, but really doesn't seem like it would be.
     private final OptimizedSmallEnumSet<Type> goalTypes = new OptimizedSmallEnumSet<>(PathfinderGoal.Type.class); // Paper - remove streams from pathfindergoalselector
 
     // Paper start make sure goaltypes is never empty
@@ -61,6 +60,8 @@ public abstract class PathfinderGoal {
 
         MOVE, LOOK, JUMP, TARGET, UNKNOWN_BEHAVIOR; // Paper - add unknown
 
+        public static Type[] VALUES = values();
+
         private Type() {}
     }
 }
diff --git a/src/main/java/net/minecraft/world/entity/ai/goal/PathfinderGoalSelector.java b/src/main/java/net/minecraft/world/entity/ai/goal/PathfinderGoalSelector.java
index 818618840ccd1656e4c15f3b4a02e06c7e7f4d33..07227275c355828268add08dcd1d0979a21fcbab 100644
--- a/src/main/java/net/minecraft/world/entity/ai/goal/PathfinderGoalSelector.java
+++ b/src/main/java/net/minecraft/world/entity/ai/goal/PathfinderGoalSelector.java
@@ -9,6 +9,8 @@ import java.util.Map;
 import java.util.Set;
 import java.util.function.Supplier;
 import java.util.stream.Stream;
+
+import dev.kamillaova.paper.SimpleEnumMap;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 
@@ -26,7 +28,7 @@ public class PathfinderGoalSelector {
             return false;
         }
     };
-    private final Map<PathfinderGoal.Type, PathfinderGoalWrapped> c = new EnumMap(PathfinderGoal.Type.class);
+    private final Map<PathfinderGoal.Type, PathfinderGoalWrapped> c = new SimpleEnumMap<>(PathfinderGoal.Type.VALUES);
     private final Set<PathfinderGoalWrapped> d = Sets.newLinkedHashSet(); public final Set<PathfinderGoalWrapped> getTasks() { return d; }// Paper - OBFHELPER // Paper - private -> public
     private final EnumSet<PathfinderGoal.Type> f = EnumSet.noneOf(PathfinderGoal.Type.class); // Paper unused, but dummy to prevent plugins from crashing as hard. Theyll need to support paper in a special case if this is super important, but really doesn't seem like it would be.
     private final OptimizedSmallEnumSet<PathfinderGoal.Type> goalTypes = new OptimizedSmallEnumSet<>(PathfinderGoal.Type.class); // Paper - remove streams from pathfindergoalselector
diff --git a/src/main/java/net/minecraft/world/entity/ai/sensing/EntitySenses.java b/src/main/java/net/minecraft/world/entity/ai/sensing/EntitySenses.java
index 54904479003f8f97ae6e5aa10a9ec672262b3ee7..cbb9144c50fab3c30edd5d24f78936c56dc15cd8 100644
--- a/src/main/java/net/minecraft/world/entity/ai/sensing/EntitySenses.java
+++ b/src/main/java/net/minecraft/world/entity/ai/sensing/EntitySenses.java
@@ -1,15 +1,15 @@
 package net.minecraft.world.entity.ai.sensing;
 
-import com.google.common.collect.Lists;
-import java.util.List;
+import it.unimi.dsi.fastutil.objects.ObjectOpenHashSet;
+import it.unimi.dsi.fastutil.objects.ObjectSet;
 import net.minecraft.world.entity.Entity;
 import net.minecraft.world.entity.EntityInsentient;
 
 public class EntitySenses {
 
     private final EntityInsentient a;
-    private final List<Entity> b = Lists.newArrayList();
-    private final List<Entity> c = Lists.newArrayList();
+    private final ObjectSet<Entity> b = new ObjectOpenHashSet<>();
+    private final ObjectSet<Entity> c = new ObjectOpenHashSet<>();
 
     public EntitySenses(EntityInsentient entityinsentient) {
         this.a = entityinsentient;
diff --git a/src/main/java/net/minecraft/world/entity/player/EntityHuman.java b/src/main/java/net/minecraft/world/entity/player/EntityHuman.java
index be7c38c54311d6ea99a4ce2eec63863b649de3b2..c0e1eb4d7dd492bea63ef27d89da1540fedf04e4 100644
--- a/src/main/java/net/minecraft/world/entity/player/EntityHuman.java
+++ b/src/main/java/net/minecraft/world/entity/player/EntityHuman.java
@@ -113,6 +113,7 @@ import net.minecraft.world.scores.Scoreboard;
 import net.minecraft.world.scores.ScoreboardTeam;
 
 // CraftBukkit start
+import net.pl3x.purpur.PurpurConfig;
 import org.bukkit.craftbukkit.entity.CraftHumanEntity;
 import org.bukkit.craftbukkit.event.CraftEventFactory;
 import org.bukkit.craftbukkit.util.CraftVector;
@@ -583,6 +584,8 @@ public abstract class EntityHuman extends EntityLiving {
     }
 
     private void j(@Nullable NBTTagCompound nbttagcompound) {
+        if (PurpurConfig.disableShitParrotSounds) return;
+
         if (nbttagcompound != null && (!nbttagcompound.hasKey("Silent") || !nbttagcompound.getBoolean("Silent")) && this.world.random.nextInt(200) == 0) {
             String s = nbttagcompound.getString("id");
 
diff --git a/src/main/java/net/minecraft/world/entity/player/PlayerInventory.java b/src/main/java/net/minecraft/world/entity/player/PlayerInventory.java
index 2df3ae0b72ccb5f816d55fed15396ba5a1affb7f..da44b9564e6434fee13289521d466a9eda46237b 100644
--- a/src/main/java/net/minecraft/world/entity/player/PlayerInventory.java
+++ b/src/main/java/net/minecraft/world/entity/player/PlayerInventory.java
@@ -28,6 +28,8 @@ import net.minecraft.world.level.block.state.IBlockData;
 
 // CraftBukkit start
 import java.util.ArrayList;
+
+import net.pl3x.purpur.PurpurConfig;
 import org.bukkit.Location;
 import org.bukkit.craftbukkit.entity.CraftHumanEntity;
 import org.bukkit.entity.HumanEntity;
@@ -247,7 +249,6 @@ public class PlayerInventory implements IInventory, INamableTileEntity {
         } else {
             j -= k;
             itemstack1.add(k);
-            itemstack1.d(5);
             return j;
         }
     }
@@ -269,18 +270,20 @@ public class PlayerInventory implements IInventory, INamableTileEntity {
     }
 
     public void j() {
-        Iterator iterator = this.f.iterator();
+        if (PurpurConfig.PurpurConfigCache.disableItemsTicking) return;
 
-        while (iterator.hasNext()) {
-            NonNullList<ItemStack> nonnulllist = (NonNullList) iterator.next();
+        this.tickItems(this.items);
+        this.tickItems(this.armor);
+        this.tickItems(this.extraSlots);
+    }
 
-            for (int i = 0; i < nonnulllist.size(); ++i) {
-                if (!((ItemStack) nonnulllist.get(i)).isEmpty()) {
-                    ((ItemStack) nonnulllist.get(i)).a(this.player.world, this.player, i, this.itemInHandIndex == i);
-                }
+    private void tickItems(NonNullList<ItemStack> list) {
+        for (int i = 0; i < list.size(); ++i) {
+            var item = list.get(i);
+            if (!item.isEmpty()) {
+                item.a(this.player.world, this.player, i, this.itemInHandIndex == i);
             }
         }
-
     }
 
     public boolean pickup(ItemStack itemstack) {
@@ -299,7 +302,6 @@ public class PlayerInventory implements IInventory, INamableTileEntity {
 
                     if (i >= 0) {
                         this.items.set(i, itemstack.cloneItemStack());
-                        ((ItemStack) this.items.get(i)).d(5);
                         itemstack.setCount(0);
                         return true;
                     } else if (this.player.abilities.canInstantlyBuild) {
diff --git a/src/main/java/net/minecraft/world/item/ItemCompass.java b/src/main/java/net/minecraft/world/item/ItemCompass.java
index 51b2d236e23a18b75cb75a8afe57db43464641d0..007593ac28f3d5b2a8f11f3175bd27c0b6ada61a 100644
--- a/src/main/java/net/minecraft/world/item/ItemCompass.java
+++ b/src/main/java/net/minecraft/world/item/ItemCompass.java
@@ -18,6 +18,7 @@ import net.minecraft.world.entity.player.EntityHuman;
 import net.minecraft.world.item.context.ItemActionContext;
 import net.minecraft.world.level.World;
 import net.minecraft.world.level.block.Blocks;
+import net.pl3x.purpur.PurpurConfig;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 
@@ -46,6 +47,8 @@ public class ItemCompass extends Item implements ItemVanishable {
 
     @Override
     public void a(ItemStack itemstack, World world, Entity entity, int i, boolean flag) {
+        if (PurpurConfig.disableCompassTicking) return;
+
         if (!world.isClientSide) {
             if (d(itemstack)) {
                 NBTTagCompound nbttagcompound = itemstack.getOrCreateTag();
diff --git a/src/main/java/net/minecraft/world/item/ItemStack.java b/src/main/java/net/minecraft/world/item/ItemStack.java
index 81ceeff37f7e03eead177cbd49f79a74be3aeeb2..948c94a6adb761714bbeb226f3da94c5b7b5e2d6 100644
--- a/src/main/java/net/minecraft/world/item/ItemStack.java
+++ b/src/main/java/net/minecraft/world/item/ItemStack.java
@@ -58,6 +58,7 @@ import net.minecraft.world.level.IMaterial;
 import net.minecraft.world.level.World;
 import net.minecraft.world.level.block.state.IBlockData;
 import net.minecraft.world.level.block.state.pattern.ShapeDetectorBlock;
+import net.pl3x.purpur.PurpurConfig;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 
@@ -112,7 +113,6 @@ public final class ItemStack {
     });
     private static final ChatModifier e = ChatModifier.a.setColor(EnumChatFormat.DARK_PURPLE).setItalic(true);
     private int count;
-    private int g;
     @Deprecated
     private Item item;
     public NBTTagCompound tag; // Paper private -> public
@@ -603,7 +603,6 @@ public final class ItemStack {
         } else {
             ItemStack itemstack = new ItemStack(origItem ? this.item : this.getItem(), this.count); // Paper
 
-            itemstack.d(this.D());
             if (this.tag != null) {
                 itemstack.tag = this.tag.clone();
             }
@@ -649,14 +648,12 @@ public final class ItemStack {
     }
 
     public void a(World world, Entity entity, int i, boolean flag) {
-        if (this.g > 0) {
-            --this.g;
-        }
+        if (PurpurConfig.PurpurConfigCache.disableItemsTicking) return;
 
-        if (this.getItem() != null) {
-            this.getItem().a(this, world, entity, i, flag);
+        var item = this.getItem();
+        if (item != null) {
+            item.a(this, world, entity, i, flag);
         }
-
     }
 
     public void a(World world, EntityHuman entityhuman, int i) {
@@ -1039,14 +1036,6 @@ public final class ItemStack {
         }
     }
 
-    public int D() {
-        return this.g;
-    }
-
-    public void d(int i) {
-        this.g = i;
-    }
-
     public int getCount() {
         return this.j ? 0 : this.count;
     }
diff --git a/src/main/java/net/minecraft/world/item/ItemWorldMap.java b/src/main/java/net/minecraft/world/item/ItemWorldMap.java
index 3aa0f19d4a924d40005a38bb95a08d4a109c5b2e..874a3c5abefb7bc83b53479b9fc209c6810c626f 100644
--- a/src/main/java/net/minecraft/world/item/ItemWorldMap.java
+++ b/src/main/java/net/minecraft/world/item/ItemWorldMap.java
@@ -31,6 +31,7 @@ import net.minecraft.world.level.material.MaterialMapColor;
 import net.minecraft.world.level.saveddata.maps.WorldMap;
 
 // CraftBukkit start
+import net.pl3x.purpur.PurpurConfig;
 import org.bukkit.Bukkit;
 import org.bukkit.event.server.MapInitializeEvent;
 // CraftBukkit end
@@ -339,6 +340,8 @@ public class ItemWorldMap extends ItemWorldMapBase {
 
     @Override
     public void a(ItemStack itemstack, World world, Entity entity, int i, boolean flag) {
+        if (PurpurConfig.disableWorldMapTicking) return;
+
         if (!world.isClientSide) {
             WorldMap worldmap = getSavedMap(itemstack, world);
 
diff --git a/src/main/java/net/pl3x/purpur/PurpurConfig.java b/src/main/java/net/pl3x/purpur/PurpurConfig.java
index 859d549cfefc7877cdc4e60821f758635caba826..552938b685d05d5f69935c064ab27f8cbbee6617 100644
--- a/src/main/java/net/pl3x/purpur/PurpurConfig.java
+++ b/src/main/java/net/pl3x/purpur/PurpurConfig.java
@@ -58,10 +58,12 @@ public class PurpurConfig {
         commands = new HashMap<>();
         commands.put("purpur", new PurpurCommand("purpur"));
 
-        version = getInt("config-version", 13);
-        set("config-version", 13);
+        version = getInt("config-version", 14);
+        set("config-version", 14);
 
         readConfig(PurpurConfig.class, null);
+
+        PurpurConfigCache.init();
     }
 
     protected static void log(String s) {
@@ -295,4 +297,66 @@ public class PurpurConfig {
         advancementOnlyBroadcastToAffectedPlayer  = getBoolean("settings.broadcasts.advancement.only-broadcast-to-affected-player", advancementOnlyBroadcastToAffectedPlayer);
         deathMessageOnlyBroadcastToAffectedPlayer = getBoolean("settings.broadcasts.death.only-broadcast-to-affected-player", deathMessageOnlyBroadcastToAffectedPlayer);
     }
+
+    public static boolean disableScoreboards = true;
+    private static void disableScoreboards() {
+        disableScoreboards = getBoolean("settings.disable-scoreboards", disableScoreboards);
+    }
+
+    public static boolean disableTeams = true;
+    private static void disableTeams() {
+        disableTeams = getBoolean("settings.disable-teams", disableTeams);
+    }
+
+    public static boolean disableTeamCollisionRule = true;
+    private static void disableTeamCollisionRule() {
+        disableTeamCollisionRule = getBoolean("settings.disable-team-collision-rule", disableTeamCollisionRule);
+    }
+
+    public static boolean disableTeamAlly = true;
+    private static void disableTeamAlly() {
+        disableTeamAlly = getBoolean("settings.disable-team-ally", disableTeamAlly);
+    }
+
+    public static boolean disableCompassTicking = true;
+    private static void disableCompassTicking() {
+        disableCompassTicking = getBoolean("settings.disable-compass-ticking", disableCompassTicking);
+    }
+
+    public static boolean disableWorldMapTicking = true;
+    private static void disableWorldMapTicking() {
+        disableWorldMapTicking = getBoolean("settings.disable-world-map-ticking", disableWorldMapTicking);
+    }
+
+    public static boolean disableShitParrotSounds = true;
+
+    private static void disableShitParrotSounds() {
+        disableShitParrotSounds = getBoolean("settings.disable-shit-parrot-sounds", disableShitParrotSounds);
+    }
+
+    public static boolean disableEntityCollisions = false;
+
+    private static void disableEntityCollisions() {
+        disableEntityCollisions = getBoolean("settings.disable-entity-cllisions", disableEntityCollisions);
+    }
+
+    public static boolean disableStatistics = false;
+
+    private static void disableStatistics() {
+        disableStatistics = getBoolean("settings.disable-statistics", disableStatistics);
+    }
+
+    public static int hardcodedViewDistance = 7;
+
+    private static void hardcodedViewDistance() {
+        hardcodedViewDistance = getInt("settings.hardcoded-view-distance", hardcodedViewDistance);
+    }
+
+    public static final class PurpurConfigCache {
+        public static boolean disableItemsTicking;
+
+        public static void init() {
+            disableItemsTicking = PurpurConfig.disableCompassTicking && PurpurConfig.disableWorldMapTicking;
+        }
+    }
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 889a80f65a6f15807ff1cd1f8f29981d762e24b8..20701009c0ea1a4f6ed7f22a713471095669d6c5 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -82,6 +82,7 @@ import net.minecraft.world.level.biome.BiomeManager;
 import net.minecraft.world.level.block.entity.TileEntitySign;
 import net.minecraft.world.level.saveddata.maps.MapIcon;
 import net.minecraft.world.phys.Vec3D;
+import net.pl3x.purpur.PurpurConfig;
 import org.apache.commons.lang.NotImplementedException;
 import org.apache.commons.lang.Validate;
 import org.bukkit.BanList;
@@ -2320,24 +2321,11 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
 
     @Override
     public int getViewDistance() {
-        net.minecraft.server.level.PlayerChunkMap chunkMap = this.getHandle().getWorldServer().getChunkProvider().playerChunkMap;
-        com.tuinity.tuinity.chunk.PlayerChunkLoader.PlayerLoaderData data = chunkMap.playerChunkManager.getData(this.getHandle());
-        if (data == null) {
-            return chunkMap.playerChunkManager.getTargetViewDistance();
-        }
-        return data.getTargetTickViewDistance();
+        return PurpurConfig.hardcodedViewDistance;
     }
 
     @Override
-    public void setViewDistance(int viewDistance) {
-        net.minecraft.server.level.PlayerChunkMap chunkMap = this.getHandle().getWorldServer().getChunkProvider().playerChunkMap;
-        com.tuinity.tuinity.chunk.PlayerChunkLoader.PlayerLoaderData data = chunkMap.playerChunkManager.getData(this.getHandle());
-        if (data == null) {
-            throw new IllegalStateException("Player is not attached to world");
-        }
-
-        data.setTargetTickViewDistance(viewDistance);
-    }
+    public void setViewDistance(int viewDistance) {}
     // Tuinity end - implement view distances
 
     @Override
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index c07ff0cc7cae358c3fd772d24c2944cc92e1acff..1107e37f90185dfe585ecf5ba8a197f1da556cfa 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -4,6 +4,7 @@ import com.google.common.base.Function;
 import com.google.common.base.Functions;
 import com.google.common.collect.Lists;
 import com.mojang.datafixers.util.Either;
+import dev.kamillaova.paper.SimpleEnumMap;
 import io.papermc.paper.event.block.BlockFailedDispenseEvent;
 import java.net.InetAddress;
 import java.util.ArrayList;
@@ -1115,8 +1116,8 @@ public class CraftEventFactory {
     private static final Function<? super Double, Double> ZERO = Functions.constant(-0.0);
 
     public static EntityDamageEvent handleLivingEntityDamageEvent(Entity damagee, DamageSource source, double rawDamage, double hardHatModifier, double blockingModifier, double armorModifier, double resistanceModifier, double magicModifier, double absorptionModifier, Function<Double, Double> hardHat, Function<Double, Double> blocking, Function<Double, Double> armor, Function<Double, Double> resistance, Function<Double, Double> magic, Function<Double, Double> absorption) {
-        Map<DamageModifier, Double> modifiers = new EnumMap<DamageModifier, Double>(DamageModifier.class);
-        Map<DamageModifier, Function<? super Double, Double>> modifierFunctions = new EnumMap<DamageModifier, Function<? super Double, Double>>(DamageModifier.class);
+        Map<DamageModifier, Double> modifiers = new SimpleEnumMap<>(DamageModifier.VALUES);
+        Map<DamageModifier, Function<? super Double, Double>> modifierFunctions = new SimpleEnumMap<>(DamageModifier.VALUES);
         modifiers.put(DamageModifier.BASE, rawDamage);
         modifierFunctions.put(DamageModifier.BASE, ZERO);
         if (source == DamageSource.FALLING_BLOCK || source == DamageSource.ANVIL) {
@@ -1148,8 +1149,8 @@ public class CraftEventFactory {
     }
 
     public static boolean handleNonLivingEntityDamageEvent(Entity entity, DamageSource source, double damage, boolean cancelOnZeroDamage, boolean cancelled) {
-        final EnumMap<DamageModifier, Double> modifiers = new EnumMap<DamageModifier, Double>(DamageModifier.class);
-        final EnumMap<DamageModifier, Function<? super Double, Double>> functions = new EnumMap(DamageModifier.class);
+        final SimpleEnumMap<DamageModifier, Double> modifiers = new SimpleEnumMap<DamageModifier, Double>(DamageModifier.VALUES);
+        final SimpleEnumMap<DamageModifier, Function<? super Double, Double>> functions = new SimpleEnumMap(DamageModifier.VALUES);
 
         modifiers.put(DamageModifier.BASE, damage);
         functions.put(DamageModifier.BASE, ZERO);
diff --git a/src/main/java/org/bukkit/craftbukkit/scheduler/CraftAsyncScheduler.java b/src/main/java/org/bukkit/craftbukkit/scheduler/CraftAsyncScheduler.java
index 3c1992e212a6d6f1db4d5b807b38d71913619fc0..8112811d12e8a2ba7c7159e6d58607e5d9018a29 100644
--- a/src/main/java/org/bukkit/craftbukkit/scheduler/CraftAsyncScheduler.java
+++ b/src/main/java/org/bukkit/craftbukkit/scheduler/CraftAsyncScheduler.java
@@ -25,22 +25,29 @@ package org.bukkit.craftbukkit.scheduler;
 
 import com.destroystokyo.paper.ServerSchedulerReportingWrapper;
 import com.google.common.util.concurrent.ThreadFactoryBuilder;
+import org.apache.logging.log4j.LogManager;
+import org.apache.logging.log4j.Logger;
 import org.bukkit.plugin.Plugin;
 
+import java.lang.invoke.MethodHandle;
 import java.util.ArrayList;
 import java.util.Iterator;
 import java.util.List;
 import java.util.concurrent.Executor;
 import java.util.concurrent.Executors;
-import java.util.concurrent.SynchronousQueue;
+import java.util.concurrent.LinkedBlockingQueue;
 import java.util.concurrent.ThreadPoolExecutor;
 import java.util.concurrent.TimeUnit;
 
 public class CraftAsyncScheduler extends CraftScheduler {
+    private static final Logger log = LogManager.getLogger(CraftAsyncScheduler.class);
+    private static final boolean DEBUG = Boolean.getBoolean("dev.kamillaova.purpur.CraftAsyncScheduler.debug");
 
     private final ThreadPoolExecutor executor = new ThreadPoolExecutor(
-            4, Integer.MAX_VALUE,30L, TimeUnit.SECONDS, new SynchronousQueue<>(),
-            new ThreadFactoryBuilder().setNameFormat("Craft Scheduler Thread - %1$d").build());
+      128, 128,
+      5L, TimeUnit.MINUTES,
+      new LinkedBlockingQueue<>(),
+      new ThreadFactoryBuilder().setNameFormat("Craft Scheduler Thread - %1$d").build());
     private final Executor management = Executors.newSingleThreadExecutor(new ThreadFactoryBuilder()
             .setNameFormat("Craft Async Scheduler Management Thread").build());
     private final List<CraftTask> temp = new ArrayList<>();
@@ -92,6 +99,9 @@ public class CraftAsyncScheduler extends CraftScheduler {
 
     private boolean executeTask(CraftTask task) {
         if (isValid(task)) {
+            if (DEBUG) {
+                log.info("CraftAsyncScheduler executeTask: " + task.rTask.getClass());
+            }
             this.runners.put(task.getTaskId(), task);
             this.executor.execute(new ServerSchedulerReportingWrapper(task));
             return true;
diff --git a/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftScoreboardManager.java b/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftScoreboardManager.java
index 4b81e285da196eb492191c6baa701f779d2a44a8..c7fe0fb93b0750d1ba56c3f48277eafa3ee22afc 100644
--- a/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftScoreboardManager.java
+++ b/src/main/java/org/bukkit/craftbukkit/scoreboard/CraftScoreboardManager.java
@@ -16,6 +16,7 @@ import net.minecraft.world.scores.ScoreboardObjective;
 import net.minecraft.world.scores.ScoreboardScore;
 import net.minecraft.world.scores.ScoreboardTeam;
 import net.minecraft.world.scores.criteria.IScoreboardCriteria;
+import net.pl3x.purpur.PurpurConfig;
 import org.apache.commons.lang.Validate;
 import org.bukkit.craftbukkit.entity.CraftPlayer;
 import org.bukkit.craftbukkit.util.WeakCollection;
@@ -106,18 +107,22 @@ public final class CraftScoreboardManager implements ScoreboardManager {
 
     // CraftBukkit method
     public void removePlayer(Player player) {
-        playerBoards.remove(player);
+        if (!PurpurConfig.disableScoreboards) {
+            playerBoards.remove(player);
+        }
     }
 
     // CraftBukkit method
     public void getScoreboardScores(IScoreboardCriteria criteria, String name, Consumer<ScoreboardScore> consumer) {
-        // Tuinity start - add timings for scoreboard search
-        // plugins leaking scoreboards will make this very expensive, let server owners debug it easily
-        // Tuinity end - add timings for scoreboard search
-        for (CraftScoreboard scoreboard : scoreboards) {
-            Scoreboard board = scoreboard.board;
-            board.getObjectivesForCriteria(criteria, name, (score) -> consumer.accept(score));
+        if (!PurpurConfig.disableScoreboards) {
+            // Tuinity start - add timings for scoreboard search
+            // plugins leaking scoreboards will make this very expensive, let server owners debug it easily
+            // Tuinity end - add timings for scoreboard search
+            for (CraftScoreboard scoreboard : scoreboards) {
+                Scoreboard board = scoreboard.board;
+                board.getObjectivesForCriteria(criteria, name, (score) -> consumer.accept(score));
+            }
+            // Tuinity end - add timings for scoreboard search
         }
-        // Tuinity end - add timings for scoreboard search
     }
 }
